name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: ['1.21', '1.22', '1.23']

    steps:
      - name: Generate GitHub App token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.BOT_APP_ID }}
          private-key: ${{ secrets.BOT_PRIVATE_KEY }}

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ steps.generate-token.outputs.token }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}

      - name: Download dependencies
        run: go mod download

      - name: Verify dependencies
        run: go mod verify

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Upload coverage to Codecov
        if: matrix.go-version == '1.23'
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: timvw/wt
          files: ./coverage.out
          fail_ci_if_error: false

  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Generate GitHub App token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.BOT_APP_ID }}
          private-key: ${{ secrets.BOT_PRIVATE_KEY }}

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ steps.generate-token.outputs.token }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Build
        run: go build -v ./...

      - name: Build binary
        run: |
          mkdir -p bin
          go build -o bin/wt .

      - name: Verify binary
        run: |
          ./bin/wt --help
          file bin/wt

  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Generate GitHub App token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.BOT_APP_ID }}
          private-key: ${{ secrets.BOT_PRIVATE_KEY }}

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ steps.generate-token.outputs.token }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest

  cross-compile:
    name: Cross Compile
    runs-on: ubuntu-latest

    steps:
      - name: Generate GitHub App token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.BOT_APP_ID }}
          private-key: ${{ secrets.BOT_PRIVATE_KEY }}

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ steps.generate-token.outputs.token }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Cross compile
        run: |
          mkdir -p bin
          GOOS=linux GOARCH=amd64 go build -o bin/wt-linux-amd64 .
          GOOS=darwin GOARCH=amd64 go build -o bin/wt-darwin-amd64 .
          GOOS=darwin GOARCH=arm64 go build -o bin/wt-darwin-arm64 .
          GOOS=windows GOARCH=amd64 go build -o bin/wt-windows-amd64.exe .

      - name: Verify binaries
        run: |
          ls -lh bin/
          file bin/*

  e2e-macos:
    name: E2E Tests (macOS)
    runs-on: macos-latest
    strategy:
      matrix:
        shell: ['bash', 'zsh']

    steps:
      - name: Generate GitHub App token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.BOT_APP_ID }}
          private-key: ${{ secrets.BOT_PRIVATE_KEY }}

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ steps.generate-token.outputs.token }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Download dependencies
        run: go mod download

      - name: Build wt binary
        run: |
          mkdir -p bin
          go build -o bin/wt .

      - name: Verify binary
        run: |
          ./bin/wt --help
          file bin/wt

      - name: Run e2e tests for ${{ matrix.shell }}
        run: |
          # Set up isolated test environment
          export TMPDIR=$(mktemp -d)
          export HOME=$TMPDIR

          # Run e2e tests with verbose output
          if [ "${{ matrix.shell }}" = "bash" ]; then
            go test -v -run TestE2EAutoCdWithNonInteractiveCommand ./...
            go test -v -run TestE2EAutoCdWithCreate ./...
          elif [ "${{ matrix.shell }}" = "zsh" ]; then
            go test -v -run TestE2EAutoCdInZsh ./...
          fi

      - name: Test shellenv output
        run: |
          # Capture shellenv output for inspection
          ./bin/wt shellenv > shellenv-${{ matrix.shell }}.txt

          # Verify shellenv produces output
          if [ ! -s shellenv-${{ matrix.shell }}.txt ]; then
            echo "ERROR: shellenv produced no output"
            exit 1
          fi

          # Check for key components (wt function)
          if ! grep -q "wt()" shellenv-${{ matrix.shell }}.txt; then
            echo "ERROR: wt function not found in shellenv output"
            exit 1
          fi

          # Verify shell-specific features
          if [ "${{ matrix.shell }}" = "bash" ]; then
            grep -q "BASH_VERSION" shellenv-${{ matrix.shell }}.txt || (echo "ERROR: bash-specific code not found" && exit 1)
          elif [ "${{ matrix.shell }}" = "zsh" ]; then
            grep -q "ZSH_VERSION" shellenv-${{ matrix.shell }}.txt || (echo "ERROR: zsh-specific code not found" && exit 1)
          fi

          echo "shellenv validation passed for ${{ matrix.shell }}"

      - name: Test worktree CRUD operations with auto-cd
        run: |
          # Create isolated test environment
          export WORKTREE_ROOT=$(mktemp -d)/worktrees
          export PATH=$(pwd)/bin:$PATH

          # Create a test git repo
          TEST_REPO=$(mktemp -d)/test-repo
          mkdir -p $TEST_REPO
          cd $TEST_REPO
          git init
          git config user.email "test@example.com"
          git config user.name "Test User"
          git commit --allow-empty -m "initial commit"
          git branch -M main

          # Create a test branch
          git checkout -b test-branch
          git commit --allow-empty -m "test commit"
          git checkout main

          # Test with shell integration (the key difference)
          if [ "${{ matrix.shell }}" = "bash" ]; then
            SHELL_CMD="bash"
          else
            SHELL_CMD="zsh"
          fi

          # Save absolute path to wt binary and its directory
          WT_BIN="$(pwd)/bin/wt"
          WT_BIN_DIR="$(pwd)/bin"

          # Generate shellenv script for the shell
          $WT_BIN shellenv > /tmp/wt-shellenv-${{ matrix.shell }}.sh

          # Run test in a subshell with shellenv sourced
          $SHELL_CMD -c "
            export WORKTREE_ROOT='$WORKTREE_ROOT'
            export PATH='$WT_BIN_DIR:\$PATH'
            cd '$TEST_REPO'
            source /tmp/wt-shellenv-${{ matrix.shell }}.sh

            echo 'Testing: wt checkout test-branch'
            wt checkout test-branch

            # Verify we're in the worktree directory
            CURRENT_DIR=\$(pwd)
            EXPECTED_DIR='$WORKTREE_ROOT/test-repo/test-branch'
            if [[ \"\$CURRENT_DIR\" != \"\$EXPECTED_DIR\" ]]; then
              echo \"ERROR: Auto-cd failed. Expected: \$EXPECTED_DIR, Got: \$CURRENT_DIR\"
              exit 1
            fi
            echo \"✓ Auto-cd to worktree verified: \$CURRENT_DIR\"

            # Verify worktree was created
            wt list | grep test-branch || (echo 'ERROR: worktree not in list' && exit 1)
            echo '✓ Worktree created and listed'

            # Go back to original repo to test create
            cd '$TEST_REPO'

            # Test create command (from main repo)
            echo 'Testing: wt create feature-test'
            wt create feature-test
            CURRENT_DIR=\$(pwd)
            EXPECTED_DIR='$WORKTREE_ROOT/test-repo/feature-test'
            if [[ \"\$CURRENT_DIR\" != \"\$EXPECTED_DIR\" ]]; then
              echo \"ERROR: Auto-cd failed for create. Expected: \$EXPECTED_DIR, Got: \$CURRENT_DIR\"
              exit 1
            fi
            echo \"✓ Auto-cd to new worktree verified: \$CURRENT_DIR\"

            # Go back to original repo to test remove
            cd '$TEST_REPO'

            # Test remove command
            echo 'Testing: wt remove test-branch'
            wt remove test-branch

            # Verify worktree was removed
            if wt list | grep test-branch; then
              echo 'ERROR: worktree not removed'
              exit 1
            fi
            echo '✓ Worktree removed successfully'

            echo 'CRUD operations with auto-cd test passed!'
          "

      - name: Upload shellenv output as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: shellenv-output-${{ matrix.shell }}
          path: shellenv-${{ matrix.shell }}.txt
          retention-days: 7

      - name: Upload test logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-logs-${{ matrix.shell }}
          path: |
            /tmp/*.log
            /var/tmp/*.log
          retention-days: 7
          if-no-files-found: ignore
